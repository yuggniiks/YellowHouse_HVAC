<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Analysis - Dynamic Vendor Comparison with Hybrid Options</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2em;
            font-weight: 300;
        }
        
        .header p {
            margin: 8px 0 0 0;
            opacity: 0.9;
            font-size: 1em;
        }
        
        .content {
            padding: 20px;
        }
        
        .section {
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 18px;
            border-left: 4px solid #3498db;
        }
        
        .section h2 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .compact-section {
            margin-bottom: 15px;
            padding: 12px;
        }
        
        .compact-section h2 {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .compact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .vendor-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .vendor-option h4 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            font-size: 1em;
        }
        
        .vendor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }
        
        .input-group {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #555;
            font-size: 12px;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 6px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .input-group small {
            display: block;
            color: #666;
            font-size: 10px;
            margin-top: 2px;
        }
        
        .remove-vendor {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        
        .add-vendor-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 8px 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 12px;
        }
        
        .results-table th {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
        }
        
        .results-table td {
            padding: 6px;
            border-bottom: 1px solid #eee;
            font-size: 11px;
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 15px 0;
            display: block;
            width: 100%;
        }
        
        .toggle-debug {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }
        
        .summary-card h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 0.9em;
        }
        
        .summary-card .value {
            font-size: 1.3em;
            font-weight: bold;
            color: #3498db;
            word-wrap: break-word;
        }
        
        .note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            color: #856404;
            font-size: 12px;
        }

        .debug-section {
            background: #f0f8ff;
            border: 1px solid #b0d4f1;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }

        .decision-flow {
            background: #e8f5e8;
            border: 2px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
        }

        .decision-flow h3 {
            color: #27ae60;
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .incremental-highlight {
            background: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 4px solid #ffc107;
            font-size: 12px;
        }
        
        .hybrid-highlight {
            background: #e6f3ff;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 4px solid #007bff;
            font-size: 12px;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .file-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-block;
            text-decoration: none;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }
        
        .file-btn:hover {
            transform: translateY(-1px);
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
        }
        
        .file-status {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 8px;
            margin: 10px 0;
            color: #155724;
            font-size: 12px;
            display: none;
        }
        
        .file-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 8px;
            margin: 10px 0;
            color: #721c24;
            font-size: 12px;
            display: none;
        }

        .calc-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .calc-section h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1.1em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .calc-details {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            background: white;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }

        .calc-step {
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .calc-step:last-child {
            border-bottom: none;
        }

        .calc-highlight {
            background: #fff3cd;
            padding: 3px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .calc-formula {
            color: #6f42c1;
            font-weight: bold;
        }

        .calc-result {
            color: #28a745;
            font-weight: bold;
        }

        @media (max-width: 1200px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            .three-column {
                grid-template-columns: 1fr;
            }
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>YellowHouse HVAC Decision Analysis</h1>
            <p>Dynamic Vendor Comparison - Baseline, Hybrid, and Premium Options</p>
        </div>
        
        <div class="content">
            <div class="decision-flow">
                <h3>üéØ Enhanced Decision Framework</h3>
                <strong>Step 1:</strong> Compare all heat pump vendors to choose your baseline repair<br>
                <strong>Step 2:</strong> Evaluate hybrid geothermal options (ground loops + upstairs replacement only)<br>
                <strong>Step 3:</strong> Compare full geothermal systems for complete replacement<br>
                <strong>Add Vendors:</strong> Use "Add Another Option" to compare unlimited quotes<br>
                <strong>Import/Export:</strong> Load vendor data from CSV/TXT files or save your analysis
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #27ae60;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <label for="fileInput" class="file-btn">üìÅ Load Vendor File</label>
                        <input type="file" id="fileInput" accept=".csv,.txt" style="display: none;" onchange="loadFile(event)">
                        <small style="display: block; margin-top: 5px;">Upload CSV with your vendor quotes</small>
                    </div>
                    <div>
                        <button class="file-btn" onclick="exportData()">üíæ Save Vendor Data</button>
                        <small style="display: block; margin-top: 5px;">Download your current vendor list as CSV</small>
                    </div>
                    <div>
                        <button class="file-btn" onclick="downloadTemplate()">üìã Get Blank Template</button>
                        <small style="display: block; margin-top: 5px;">Download empty CSV template to fill in</small>
                    </div>
                    <div>
                        <button class="file-btn" onclick="loadExampleData()">üéØ Load Example Data</button>
                        <small style="display: block; margin-top: 5px;">See analysis with real vendor quotes</small>
                    </div>
                </div>
                    <div id="fileStatus" class="file-status"></div>
                    <div id="fileError" class="file-error"></div>
                </div>
            </div>

            <div class="two-column">
                <div class="section compact-section">
                    <h2>üí∞ Financial Parameters</h2>
                    <div class="compact-grid">
                        <div class="input-group">
                            <label for="electricityRate">Electricity Rate ($/kWh)</label>
                            <input type="number" id="electricityRate" value="0.169" step="0.001" onchange="calculateAll()">
                            <small>Current total rate</small>
                        </div>
                        <div class="input-group">
                            <label for="inflationRate">Annual Rate Increase (%)</label>
                            <input type="number" id="inflationRate" value="3.5" step="0.1" onchange="calculateAll()">
                            <small>Historical 3-4%</small>
                        </div>
                        <div class="input-group">
                            <label for="discountRate">Discount Rate (%)</label>
                            <input type="number" id="discountRate" value="3" step="0.1" onchange="calculateAll()">
                            <small>Time value of money</small>
                        </div>
                        <div class="input-group">
                            <label for="taxCredit">Tax Credit (%)</label>
                            <input type="number" id="taxCredit" value="30" onchange="calculateAll()">
                            <small>Geothermal systems only</small>
                        </div>
                    </div>
                </div>

                <div class="section compact-section">
                    <h2>üè† Current System</h2>
                    <div class="compact-grid">
                        <div class="input-group">
                            <label for="currentAnnualCost">Annual Energy Cost ($)</label>
                            <input type="number" id="currentAnnualCost" value="3443" onchange="calculateAll()">
                            <small>Current bill</small>
                        </div>
                        <div class="input-group">
                            <label for="brokenSystemPenalty">Broken System Extra ($)</label>
                            <input type="number" id="brokenSystemPenalty" value="800" onchange="calculateAll()">
                            <small>Upstairs broken cost</small>
                        </div>
                        <div class="input-group">
                            <label for="currentSEER">Current Avg SEER</label>
                            <input type="number" id="currentSEER" value="11.75" step="0.1" onchange="calculateAll()">
                            <small>Mixed system avg</small>
                        </div>
                        <div class="input-group">
                            <label for="currentHSPF">Current Avg HSPF</label>
                            <input type="number" id="currentHSPF" value="7.4" step="0.1" onchange="calculateAll()">
                            <small>Mixed system avg</small>
                        </div>
                        
                        <div class="input-group">
                            <label for="heatPumpLifespan">Heat Pump Lifespan (years)</label>
                            <input type="number" id="heatPumpLifespan" value="18" onchange="calculateAll()">
                            <small>Typical 15-20 years</small>
                        </div>
                        <div class="input-group">
                            <label for="geothermalLifespan">Geothermal Lifespan (years)</label>
                            <input type="number" id="geothermalLifespan" value="25" onchange="calculateAll()">
                            <small>Units: 20-25, loops: 50+</small>
                        </div>



                    </div>
                </div>
            </div>

            <div class="section compact-section">
                <h2>üå°Ô∏è Weather Impact (Heat Pumps Only)</h2>
                <div class="compact-grid">
                    <div class="input-group">
                        <label for="emergencyHeatDays">Emergency Heat Days</label>
                        <input type="number" id="emergencyHeatDays" value="35" onchange="calculateAll()">
                        <small>Days below 20¬∞F</small>
                    </div>
                    <div class="input-group">
                        <label for="emergencyHeatCost">Emergency Heat Cost ($/day)</label>
                        <input type="number" id="emergencyHeatCost" value="12" onchange="calculateAll()">
                        <small>Extra daily cost</small>
                    </div>
                    <div class="input-group">
                        <label for="hotDayPenalty">Hot Day Loss (%)</label>
                        <input type="number" id="hotDayPenalty" value="15" onchange="calculateAll()">
                        <small>Efficiency loss 90¬∞F+</small>
                    </div>
                    <div class="input-group">
                        <label for="hotDaysPerYear">Hot Days/Year</label>
                        <input type="number" id="hotDaysPerYear" value="22" onchange="calculateAll()">
                        <small>Central PA average</small>
                    </div>
                </div>
            </div>

            <div class="section compact-section">
                <h2>üõ†Ô∏è Maintenance & Replacement Costs</h2>
                <div class="compact-grid">
                    <div class="input-group">
                        <label for="hpMaintenance">Heat Pump Annual Maint. ($)</label>
                        <input type="number" id="hpMaintenance" value="300" onchange="calculateAll()">
                        <small>E.g., annual service contract</small>
                    </div>
                    <div class="input-group">
                        <label for="geoMaintenance">Geothermal Annual Maint. ($)</label>
                        <input type="number" id="geoMaintenance" value="150" onchange="calculateAll()">
                        <small>Filter changes, checkups</small>
                    </div>
                    <div class="input-group">
                        <label for="geoReplacementCost">Geo. Unit Replacement Cost ($)</label>
                        <input type="number" id="geoReplacementCost" value="15000" onchange="calculateAll()">
                        <small>At end of life (e.g., 25 yrs)</small>
                    </div>
                </div>
            </div>

            <div class="three-column">
                <div class="section baseline-section compact-section">
                    <h2>üîß Heat Pump Options</h2>
                    <div style="background: #e8f5e8; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 12px;">
                        <strong>Baseline:</strong> Replace broken upstairs unit only
                    </div>
                    
                    <div id="heatPumpVendors">
                        </div>
                    
                    <button class="add-vendor-btn" onclick="addHeatPumpVendor()">
                        ‚ûï Add Heat Pump Quote
                    </button>
                </div>

                <div class="section hybrid-section compact-section">
                    <h2>üîÑ Hybrid Geothermal</h2>
                    <div style="background: #e6f3ff; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 12px;">
                        <strong>Hybrid:</strong> Ground loops + upstairs replacement only<br>
                        <strong>Future:</strong> Downstairs ready for later upgrade
                    </div>
                    
                    <div id="hybridVendors">
                        </div>
                    
                    <button class="add-vendor-btn" onclick="addHybridVendor()">
                        ‚ûï Add Hybrid Quote
                    </button>
                </div>

                <div class="section upgrade-section compact-section">
                    <h2>‚ö° Full Geothermal</h2>
                    <div style="background: #ffe6e6; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 12px;">
                        <strong>Premium:</strong> Full system replacement<br>
                        <strong>Complete:</strong> Both upstairs & downstairs
                    </div>
                    
                    <div id="geothermalVendors">
                        </div>
                    
                    <button class="add-vendor-btn" onclick="addGeothermalVendor()">
                        ‚ûï Add Full Geothermal Quote
                    </button>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateAll()">üîÑ Calculate Analysis</button>

            <button class="toggle-debug" onclick="toggleDebug()">Toggle Debug Info</button>
            <div class="debug-section" id="debugSection" style="display: none;">
                <strong>Calculation Details:</strong><br>
                <div id="debugOutput"></div>
            </div>

            <div class="section baseline-section">
                <h2>üîß Step 1: Choose Your Baseline Heat Pump</h2>
                <div style="margin-bottom: 15px; background: #e8f5e8; padding: 15px; border-radius: 6px; color: #2d5f2d;">
                    <strong>Baseline Comparison:</strong> All options replace only the broken upstairs unit and keep your good 2022 downstairs unit.
                </div>
                <table class="results-table baseline-table" id="baselineTable">
                    <thead>
                        <tr>
                            <th>Heat Pump Option</th>
                            <th>Installation Cost</th>
                            <th>System Efficiency</th>
                            <th>Annual Energy Cost</th>
                            <th>Annual Total Cost</th>
                            <th>Annual Savings vs Broken</th>
                        </tr>
                    </thead>
                    <tbody id="baselineBody"></tbody>
                </table>
            </div>

            <div class="section hybrid-section">
                <h2>üîÑ Step 2: Hybrid Geothermal Analysis</h2>
                <div class="hybrid-highlight">
                    <strong>Hybrid Strategy:</strong> Install ground loops for whole house efficiency + replace upstairs unit only.<br>
                    <strong>Future Ready:</strong> Downstairs unit can connect to existing loops when ready for replacement.
                </div>
                <table class="results-table hybrid-table" id="hybridTable">
                    <thead>
                        <tr>
                            <th>Hybrid Option</th>
                            <th>Extra Investment</th>
                            <th>Tax Credit</th>
                            <th>Net Extra Cost</th>
                            <th>Extra Annual Savings</th>
                            <th>Simple Payback</th>
                        </tr>
                    </thead>
                    <tbody id="hybridBody"></tbody>
                </table>
            </div>

            <div class="section upgrade-section">
                <h2>‚ö° Step 3: Full Geothermal Analysis</h2>
                <div class="incremental-highlight">
                    <strong>Complete System:</strong> Compares full geothermal replacement against your best baseline choice.
                </div>
                <table class="results-table upgrade-table" id="upgradeTable">
                    <thead>
                        <tr>
                            <th>Full Geothermal Option</th>
                            <th>Extra Investment</th>
                            <th>Tax Credit</th>
                            <th>Net Extra Cost</th>
                            <th>Extra Annual Savings</th>
                            <th>Simple Payback</th>
                        </tr>
                    </thead>
                    <tbody id="upgradeBody"></tbody>
                </table>
            </div>

            <div class="section">
                <h2>üí∞ Net Present Value Analysis</h2>
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    <strong>Incremental NPV:</strong> Shows the value of choosing each option over the best heat pump baseline.
                    Green = upgrade pays off, Red = baseline is better value.
                </div>
                <table class="results-table" id="npvTable">
                    <thead>
                        <tr>
                            <th>Option</th>
                            <th>Type</th>
                            <th>Net Extra Investment</th>
                            <th>5 Year NPV</th>
                            <th>10 Year NPV</th>
                            <th>15 Year NPV</th>
                            <th>20 Year NPV</th>
                        </tr>
                    </thead>
                    <tbody id="npvBody"></tbody>
                </table>
            </div>

            <div class="summary-cards">
                <div class="summary-card baseline-card">
                    <h3>Best Heat Pump</h3>
                    <div class="value" id="bestHeatPump">-</div>
                </div>
                <div class="summary-card hybrid-card">
                    <h3>Best Hybrid Option</h3>
                    <div class="value" id="bestHybrid">-</div>
                </div>
                <div class="summary-card upgrade-card">
                    <h3>Best Full Geothermal</h3>
                    <div class="value" id="bestGeo">-</div>
                </div>
                <div class="summary-card">
                    <h3>Overall Recommendation</h3>
                    <div class="value" id="recommendation">-</div>
                </div>
            </div>

            <div class="section">
                <h2>üìà 30-Year Total Cost Projection</h2>
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    <strong>Cumulative Total Cost:</strong> Shows initial investment plus accumulated energy costs over time.
                    Watch for crossover points where geothermal systems become more cost-effective than heat pumps.
                </div>
                <div style="position: relative; height: 500px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <canvas id="costProjectionChart" style="width: 100%; height: 100%;"></canvas>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    <strong>Key Insights:</strong> Lines that cross show break-even points. Lower lines after year 20+ indicate better long-term value.
                </div>
            </div>

            <div class="note">
                <strong>Enhanced Hybrid Analysis:</strong><br>
                ‚Ä¢ <strong>Three-Tier Comparison:</strong> Heat pump baseline, hybrid geothermal, and full geothermal systems<br>
                ‚Ä¢ <strong>Hybrid Strategy:</strong> Ground loops provide efficient foundation with immediate upstairs replacement<br>
                ‚Ä¢ <strong>Future Flexibility:</strong> Downstairs unit can connect to existing loops when replacement is needed<br>
                ‚Ä¢ <strong>Tax Credit Optimization:</strong> Hybrid systems qualify for 30% federal tax credit on geothermal components<br>
                ‚Ä¢ <strong>Phased Investment:</strong> Spread costs over time while capturing immediate efficiency gains
            </div>
        </div>
    </div>

    <script>
        let heatPumpCounter = 0;
        let hybridCounter = 0;
        let geothermalCounter = 0;

        function getVal(id) {
            const element = document.getElementById(id);
            return element ? parseFloat(element.value) || 0 : 0;
        }

        function getText(id) {
            const element = document.getElementById(id);
            return element ? element.value || '' : '';
        }

        function toggleDebug() {
            const debugSection = document.getElementById('debugSection');
            debugSection.style.display = debugSection.style.display === 'none' ? 'block' : 'none';
        }

        // *** MODIFIED FUNCTION ***
        // Now creates different inputs for Heat Pump vs Geothermal/Hybrid
        function createVendorHTML(type, id, name, cost, rating1, rating2) {
            const isRemovable = (type === 'hp' && heatPumpCounter > 1) || 
                              (type === 'hybrid' && hybridCounter > 1) || 
                              (type === 'geo' && geothermalCounter > 1);
            
            let typeLabel, typeColor, rating1Label, rating2Label, rating1Id, rating2Id, rating1Help, rating2Help;

            switch(type) {
                case 'hp':
                    typeLabel = 'Heat Pump';
                    typeColor = '#3498db';
                    rating1Label = 'SEER2 Rating';
                    rating2Label = 'HSPF2 Rating';
                    rating1Id = `hpSEER${id}`;
                    rating2Id = `hpHSPF${id}`;
                    rating1Help = 'Cooling efficiency';
                    rating2Help = 'Heating efficiency';
                    break;
                case 'hybrid':
                    typeLabel = 'Hybrid Geothermal';
                    typeColor = '#007bff';
                    rating1Label = 'EER Rating';
                    rating2Label = 'COP Rating';
                    rating1Id = `hybridEER${id}`;
                    rating2Id = `hybridCOP${id}`;
                    rating1Help = 'Geo Cooling (EER)';
                    rating2Help = 'Geo Heating (COP)';
                    break;
                case 'geo':
                    typeLabel = 'Full Geothermal';
                    typeColor = '#e74c3c';
                    rating1Label = 'EER Rating';
                    rating2Label = 'COP Rating';
                    rating1Id = `geoEER${id}`;
                    rating2Id = `geoCOP${id}`;
                    rating1Help = 'Geo Cooling (EER)';
                    rating2Help = 'Geo Heating (COP)';
                    break;
            }
            
            const removeButton = isRemovable ? `<button class="remove-vendor" onclick="removeVendor('${type}', ${id})" title="Remove this vendor">‚úó</button>` : '';
            
            return `
                <div class="vendor-option" id="${type}Vendor${id}">
                    ${removeButton}
                    <h4 style="border-bottom-color: ${typeColor}">${typeLabel} Option ${id}</h4>
                    <div class="vendor-grid">
                        <div class="input-group">
                            <label for="${type}Name${id}">Vendor/Option Name</label>
                            <input type="text" id="${type}Name${id}" value="${name}" onchange="calculateAll()">
                            <small>Custom name for this option</small>
                        </div>
                        <div class="input-group">
                            <label for="${type}Cost${id}">Total Cost ($)</label>
                            <input type="number" id="${type}Cost${id}" value="${cost}" onchange="calculateAll()">
                            <small>Total installed cost</small>
                        </div>
                        <div class="input-group">
                            <label for="${rating1Id}">${rating1Label}</label>
                            <input type="number" id="${rating1Id}" value="${rating1}" step="0.1" onchange="calculateAll()">
                            <small>${rating1Help}</small>
                        </div>
                        <div class="input-group">
                            <label for="${rating2Id}">${rating2Label}</label>
                            <input type="number" id="${rating2Id}" value="${rating2}" step="0.1" onchange="calculateAll()">
                            <small>${rating2Help}</small>
                        </div>
                    </div>
                </div>
            `;
        }


        function addHeatPumpVendor() {
            heatPumpCounter++;
            const container = document.getElementById('heatPumpVendors');
            const vendorHTML = createVendorHTML('hp', heatPumpCounter, `Heat Pump Option ${heatPumpCounter}`, 10000, 15, 8.2);
            container.insertAdjacentHTML('beforeend', vendorHTML);
            calculateAll();
        }

        function addHybridVendor() {
            hybridCounter++;
            const container = document.getElementById('hybridVendors');
            // Using EER/COP values now
            const vendorHTML = createVendorHTML('hybrid', hybridCounter, `Hybrid Option ${hybridCounter}`, 35000, 20, 4.5);
            container.insertAdjacentHTML('beforeend', vendorHTML);
            calculateAll();
        }

        function addGeothermalVendor() {
            geothermalCounter++;
            const container = document.getElementById('geothermalVendors');
            // Using EER/COP values now
            const vendorHTML = createVendorHTML('geo', geothermalCounter, `Full Geothermal Option ${geothermalCounter}`, 50000, 22, 5.0);
            container.insertAdjacentHTML('beforeend', vendorHTML);
            calculateAll();
        }

        function removeVendor(type, id) {
            const vendorElement = document.getElementById(`${type}Vendor${id}`);
            if (vendorElement) {
                vendorElement.remove();
                calculateAll();
            }
        }

        function initializeVendors() {
            const heatPumpContainer = document.getElementById('heatPumpVendors');
            const hybridContainer = document.getElementById('hybridVendors');
            const geothermalContainer = document.getElementById('geothermalVendors');
            
            heatPumpContainer.innerHTML = '';
            hybridContainer.innerHTML = '';
            geothermalContainer.innerHTML = '';
            
            heatPumpCounter = 0;
            hybridCounter = 0;
            geothermalCounter = 0;
        }

        // *** MODIFIED FUNCTION ***
        // This function remains the same, but the getters below will now feed it the correct values.
        function getHeatPumpOptions() {
            const options = [];
            const hpMaintenance = getVal('hpMaintenance'); // Get value from new input
            for (let i = 1; i <= heatPumpCounter; i++) {
                const element = document.getElementById(`hpVendor${i}`);
                if (element) {
                    options.push({
                        id: i,
                        name: getText(`hpName${i}`),
                        cost: getVal(`hpCost${i}`),
                        seer: getVal(`hpSEER${i}`),
                        hspf: getVal(`hpHSPF${i}`),
                        maintenance: hpMaintenance, // Use the new input value
                        type: 'HP'
                    });
                }
            }
            return options;
        }

        // *** MODIFIED FUNCTION ***
        // Reads EER/COP and converts them to equivalent SEER/HSPF
        function getHybridOptions() {
            const options = [];
            // For hybrid, let's average the HP and Geo maintenance costs
            const hybridMaintenance = (getVal('hpMaintenance') + getVal('geoMaintenance')) / 2;
            for (let i = 1; i <= hybridCounter; i++) {
                const element = document.getElementById(`hybridVendor${i}`);
                if (element) {
                    const eer = getVal(`hybridEER${i}`);
                    const cop = getVal(`hybridCOP${i}`);
                    const equivalentSEER = eer * 1.15;
                    const equivalentHSPF = cop * 2.7;
                    
                    options.push({
                        id: i,
                        name: getText(`hybridName${i}`),
                        cost: getVal(`hybridCost${i}`),
                        seer: equivalentSEER,
                        hspf: equivalentHSPF,
                        eer: eer,
                        cop: cop,
                        maintenance: hybridMaintenance, // Use calculated hybrid maintenance
                        type: 'HYBRID'
                    });
                }
            }
            return options;
        }

        function getGeothermalOptions() {
            const options = [];
            const geoMaintenance = getVal('geoMaintenance'); // Get value from new input
            for (let i = 1; i <= geothermalCounter; i++) {
                const element = document.getElementById(`geoVendor${i}`);
                if (element) {
                    const eer = getVal(`geoEER${i}`);
                    const cop = getVal(`geoCOP${i}`);
                    const equivalentSEER = eer * 1.15;
                    const equivalentHSPF = cop * 2.7;

                    options.push({
                        id: i,
                        name: getText(`geoName${i}`),
                        cost: getVal(`geoCost${i}`),
                        seer: equivalentSEER,
                        hspf: equivalentHSPF,
                        eer: eer, 
                        cop: cop, 
                        maintenance: geoMaintenance, // Use the new input value
                        type: 'GEO'
                    });
                }
            }
            return options;
        }


        function calculateNewEnergyCost(newSEER, newHSPF, type) {
            const currentEnergyCost = getVal('currentAnnualCost');
            const currentSEER = getVal('currentSEER');
            const currentHSPF = getVal('currentHSPF');
            
            let effectiveSEER, effectiveHSPF;
            
            if (type === 'HP') {
                const downstairsSEER = 14.5; // 2022 unit
                const downstairsHSPF = 8.35; // 2022 unit
                effectiveSEER = (0.65 * newSEER) + (0.35 * downstairsSEER);
                effectiveHSPF = (0.65 * newHSPF) + (0.35 * downstairsHSPF);
            } else if (type === 'HYBRID') {
                const downstairsSEER = 14.5; // 2022 unit (still air-to-air)
                const downstairsHSPF = 8.35; // 2022 unit (still air-to-air)
                effectiveSEER = (0.65 * newSEER) + (0.35 * downstairsSEER);
                effectiveHSPF = (0.65 * newHSPF) + (0.35 * downstairsHSPF);
            } else {
                // Full geothermal - complete system replacement
                effectiveSEER = newSEER;
                effectiveHSPF = newHSPF;
            }
            
            const seerImprovement = (currentSEER > 0) ? effectiveSEER / currentSEER : 1;
            const hspfImprovement = (currentHSPF > 0) ? effectiveHSPF / currentHSPF : 1;
            
            const overallEfficiencyFactor = (0.6 * seerImprovement) + (0.4 * hspfImprovement);
            
            let newEnergyCost = (overallEfficiencyFactor > 0) ? currentEnergyCost / overallEfficiencyFactor : currentEnergyCost;
            
            // Add weather penalties for heat pumps only (hybrid gets partial penalty)
            if (type === 'HP' || type === 'HYBRID') {
                const emergencyHeatDays = getVal('emergencyHeatDays');
                const emergencyHeatCost = getVal('emergencyHeatCost');
                const hotDayPenalty = getVal('hotDayPenalty') / 100;
                const hotDaysPerYear = getVal('hotDaysPerYear');
                
                // Weather penalty affects only the air-source portion of the system
                const weatherFactor = (type === 'HP') ? 1.0 : 0.35; // 100% for HP, 35% for Hybrid

                const winterPenalty = emergencyHeatDays * emergencyHeatCost * weatherFactor;
                const summerPenalty = (currentEnergyCost * 0.6) * hotDayPenalty * (hotDaysPerYear / 120) * weatherFactor;
                
                newEnergyCost += winterPenalty + summerPenalty;
            }
            // Full geothermal gets no weather penalty
            
            return newEnergyCost;
        }

        function calculateAll() {
            const taxCreditRate = getVal('taxCredit') / 100;
            const discountRate = getVal('discountRate') / 100;
            const inflationRate = getVal('inflationRate') / 100;
            const currentTotalCost = getVal('currentAnnualCost') + getVal('brokenSystemPenalty');
            
            const baselineBody = document.getElementById('baselineBody');
            const hybridBody = document.getElementById('hybridBody');
            const upgradeBody = document.getElementById('upgradeBody');
            const npvBody = document.getElementById('npvBody');
            const debugOutput = document.getElementById('debugOutput');
            
            baselineBody.innerHTML = '';
            hybridBody.innerHTML = '';
            upgradeBody.innerHTML = '';
            npvBody.innerHTML = '';
            
            let debugText = `Current total annual cost (broken system): ${currentTotalCost.toLocaleString()}<br>`;
            debugText += `Discount rate: ${(discountRate * 100).toFixed(1)}%, Inflation rate: ${(inflationRate * 100).toFixed(1)}%<br><br>`;
            
            const heatPumpResults = [];
            const hybridResults = [];
            const geothermalResults = [];
            
            debugText += `<strong>=== BASELINE HEAT PUMP OPTIONS ===</strong><br>`;
            const heatPumpOptions = getHeatPumpOptions();
            
            heatPumpOptions.forEach(option => {
                if (option.cost > 0 && option.name.trim()) {
                    const newEnergyCost = calculateNewEnergyCost(option.seer, option.hspf, option.type);
                    const totalNewAnnualCost = newEnergyCost + option.maintenance;
                    const annualSavings = currentTotalCost - totalNewAnnualCost;
                    
                    debugText += `${option.name}: Cost ${option.cost.toLocaleString()}, `;
                    debugText += `Energy ${newEnergyCost.toFixed(0)}, Total Annual ${totalNewAnnualCost.toFixed(0)}, `;
                    debugText += `Savings ${annualSavings.toFixed(0)}<br>`;
                    
                    heatPumpResults.push({
                        ...option,
                        energyCost: newEnergyCost,
                        totalAnnualCost: totalNewAnnualCost,
                        annualSavings: annualSavings
                    });
                }
            });
            
            if (heatPumpResults.length === 0) {
                debugText += `<br><strong>No valid heat pump options found</strong><br><br>`;
                debugOutput.innerHTML = debugText;
                generateCostProjectionChart([], [], []);
                return;
            }
            
            const bestHeatPump = heatPumpResults.reduce((best, current) => 
                current.totalAnnualCost < best.totalAnnualCost ? current : best
            );
            
            debugText += `<br><strong>Best Heat Pump Baseline:</strong> ${bestHeatPump.name} with ${bestHeatPump.totalAnnualCost.toFixed(0)} annual cost<br><br>`;
            
            const calculateUpgradeMetrics = (option) => {
                const taxCredit = (option.type !== 'HP') ? option.cost * taxCreditRate : 0;
                const netCost = option.cost - taxCredit;
                const newEnergyCost = calculateNewEnergyCost(option.seer, option.hspf, option.type);
                const totalNewAnnualCost = newEnergyCost + option.maintenance;

                const extraInvestment = option.cost - bestHeatPump.cost;
                const netExtraInvestment = netCost - bestHeatPump.cost;
                const extraAnnualSavings = bestHeatPump.totalAnnualCost - totalNewAnnualCost;
                const simplePayback = extraAnnualSavings > 0 ? netExtraInvestment / extraAnnualSavings : 999;

                debugText += `${option.name} (Type: ${option.type}): Extra cost ${extraInvestment.toLocaleString()} (net: ${netExtraInvestment.toLocaleString()}), `;
                debugText += `Extra savings ${extraAnnualSavings.toFixed(0)}/yr, Payback ${simplePayback.toFixed(1)} years<br>`;

                // Calculate NPV
                const heatPumpLifespan = getVal('heatPumpLifespan');
                const geothermalLifespan = getVal('geothermalLifespan');
                let cumulativeNPV = -netExtraInvestment;
                const npvAtIntervals = {};

                for (let year = 1; year <= 30; year++) {
                    const inflatedSavings = extraAnnualSavings * Math.pow(1 + inflationRate, year - 1);
                    const presentValue = inflatedSavings / Math.pow(1 + discountRate, year);
                    cumulativeNPV += presentValue;

                    // Geothermal replacement cost (benefit for geo as HP needs replacement sooner)
                    if (year === geothermalLifespan && (option.type === 'HYBRID' || option.type === 'GEO')) {
                        const replacementCost = option.cost * 0.7; // Assume 70% for unit, not loops
                        const inflatedReplacementCost = replacementCost * Math.pow(1 + inflationRate, year - 1);
                        cumulativeNPV -= inflatedReplacementCost / Math.pow(1 + discountRate, year);
                    }

                    // Heat pump baseline replacement cost (avoided cost)
                    if (year === heatPumpLifespan) {
                        const baselineReplacementCost = bestHeatPump.cost * Math.pow(1 + inflationRate, year - 1);
                        cumulativeNPV += baselineReplacementCost / Math.pow(1 + discountRate, year);
                    }
                    
                    // Second heat pump replacement if lifespan is short
                    if (year === heatPumpLifespan * 2) {
                         const baselineReplacementCost = bestHeatPump.cost * Math.pow(1 + inflationRate, year - 1);
                        cumulativeNPV += baselineReplacementCost / Math.pow(1 + discountRate, year);
                    }

                    if ([5, 10, 15, 20].includes(year)) {
                        npvAtIntervals[year] = cumulativeNPV;
                    }
                }

                return {
                    ...option,
                    netCost: netCost,
                    taxCredit: taxCredit,
                    energyCost: newEnergyCost,
                    totalAnnualCost: totalNewAnnualCost,
                    extraInvestment: extraInvestment,
                    netExtraInvestment: netExtraInvestment,
                    extraAnnualSavings: extraAnnualSavings,
                    simplePayback: simplePayback,
                    npv5yr: npvAtIntervals[5],
                    npv10yr: npvAtIntervals[10],
                    npv15yr: npvAtIntervals[15],
                    npv20yr: npvAtIntervals[20]
                };
            };
            
            debugText += `<br><strong>=== HYBRID GEOTHERMAL OPTIONS ===</strong><br>`;
            const hybridOptions = getHybridOptions();
            hybridOptions.forEach(option => {
                if (option.cost > 0 && option.name.trim()) {
                    hybridResults.push(calculateUpgradeMetrics(option));
                }
            });

            debugText += `<br><strong>=== FULL GEOTHERMAL OPTIONS ===</strong><br>`;
            const geothermalOptions = getGeothermalOptions();
            geothermalOptions.forEach(option => {
                if (option.cost > 0 && option.name.trim()) {
                    geothermalResults.push(calculateUpgradeMetrics(option));
                }
            });

            debugOutput.innerHTML = debugText;
            
            const formatCurrency = (val) => val.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
            const formatNPV = (value) => {
                const color = value >= 0 ? '#27ae60' : '#e74c3c';
                return `<span style="color:${color}; font-weight:bold;">${formatCurrency(value)}</span>`;
            };
            const formatPayback = (years) => {
                if (years > 50) return 'Never';
                return `${years.toFixed(1)} years`;
            };
            
            heatPumpResults.forEach((result) => {
                const row = baselineBody.insertRow();
                row.innerHTML = `
                    <td><strong>${result.name}</strong></td>
                    <td>${formatCurrency(result.cost)}</td>
                    <td>${result.seer} SEER2 / ${result.hspf} HSPF2</td>
                    <td>${formatCurrency(result.energyCost)}</td>
                    <td>${formatCurrency(result.totalAnnualCost)}</td>
                    <td><strong>${formatCurrency(result.annualSavings)}</strong></td>
                `;
                if (result.name === bestHeatPump.name) {
                    row.style.backgroundColor = '#e8f5e8';
                }
            });
            
            const populateUpgradeTable = (body, results) => {
                results.forEach((result) => {
                    const row = body.insertRow();
                    row.innerHTML = `
                        <td><strong>${result.name}</strong></td>
                        <td>${formatCurrency(result.extraInvestment)}</td>
                        <td>${formatCurrency(result.taxCredit)}</td>
                        <td>${formatCurrency(result.netExtraInvestment)}</td>
                        <td><strong>${formatCurrency(result.extraAnnualSavings)}</strong></td>
                        <td>${formatPayback(result.simplePayback)}</td>
                    `;
                });
            };

            populateUpgradeTable(hybridBody, hybridResults);
            populateUpgradeTable(upgradeBody, geothermalResults);
            
            [...hybridResults, ...geothermalResults].forEach((result) => {
                const row = npvBody.insertRow();
                const type = hybridResults.includes(result) ? 'Hybrid' : 'Full Geothermal';
                row.innerHTML = `
                    <td><strong>${result.name}</strong></td>
                    <td>${type}</td>
                    <td>${formatCurrency(result.netExtraInvestment)}</td>
                    <td>${formatNPV(result.npv5yr)}</td>
                    <td>${formatNPV(result.npv10yr)}</td>
                    <td>${formatNPV(result.npv15yr)}</td>
                    <td>${formatNPV(result.npv20yr)}</td>
                `;
            });
            
            let bestHybrid = null;
            let bestGeo = null;
            
            if (hybridResults.length > 0) {
                bestHybrid = hybridResults.reduce((best, current) => 
                    current.npv20yr > best.npv20yr ? current : best
                );
            }
            
            if (geothermalResults.length > 0) {
                bestGeo = geothermalResults.reduce((best, current) => 
                    current.npv20yr > best.npv20yr ? current : best
                );
            }
            
            let recommendation = bestHeatPump.name;
            let bestOverallNPV = 0; 
            
            if (bestHybrid && bestHybrid.npv20yr > bestOverallNPV) {
                recommendation = bestHybrid.name;
                bestOverallNPV = bestHybrid.npv20yr;
            }
            
            if (bestGeo && bestGeo.npv20yr > bestOverallNPV) {
                recommendation = bestGeo.name;
            }
            
            document.getElementById('bestHeatPump').textContent = bestHeatPump.name;
            document.getElementById('bestHybrid').textContent = bestHybrid ? bestHybrid.name : 'N/A';
            document.getElementById('bestGeo').textContent = bestGeo ? bestGeo.name : 'N/A';
            document.getElementById('recommendation').textContent = recommendation;
            
            generateCostProjectionChart(heatPumpResults, hybridResults, geothermalResults);
        }
        
        // This function does not need changes, it will correctly plot the data it receives.
        function generateCostProjectionChart(heatPumpResults, hybridResults, geothermalResults) {
             const canvas = document.getElementById('costProjectionChart');
             if (!canvas) return;
            
             const ctx = canvas.getContext('2d');
             if (window.devicePixelRatio > 1) {
                 const canvasRect = canvas.getBoundingClientRect();
                 canvas.width = canvasRect.width * window.devicePixelRatio;
                 canvas.height = canvasRect.height * window.devicePixelRatio;
                 ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
                 canvas.style.width = canvasRect.width + 'px';
                 canvas.style.height = canvasRect.height + 'px';
             } else {
                 const canvasRect = canvas.getBoundingClientRect();
                 canvas.width = canvasRect.width;
                 canvas.height = canvasRect.height;
             }
            
             ctx.clearRect(0, 0, canvas.width, canvas.height);
             const chartContainer = canvas.parentElement;
            
             if (heatPumpResults.length === 0) {
                 ctx.fillStyle = '#666';
                 ctx.font = '16px Arial';
                 ctx.textAlign = 'center';
                 ctx.fillText('Add vendor options to see cost projection', chartContainer.clientWidth / 2, chartContainer.clientHeight / 2);
                 return;
             }
            
             const inflationRate = getVal('inflationRate') / 100;
             const years = 30;
            
             const allOptions = [...heatPumpResults, ...hybridResults, ...geothermalResults];
             const projectionData = [];
            
             allOptions.forEach(option => {
                 const yearlyData = [];
                 let cumulativeCost = (option.type === 'HP') ? option.cost : option.netCost;
                 yearlyData.push({ year: 0, cost: cumulativeCost });

                 for (let year = 1; year <= years; year++) {
                     const inflatedAnnualCost = option.totalAnnualCost * Math.pow(1 + inflationRate, year - 1);
                     cumulativeCost += inflatedAnnualCost;
                     yearlyData.push({ year: year, cost: cumulativeCost });

                     const heatPumpLifespan = getVal('heatPumpLifespan');
                     const geothermalLifespan = getVal('geothermalLifespan');
                     let replacementCost = 0;

                     if (option.type === 'HP' && year > 0 && year % heatPumpLifespan === 0) {
                         replacementCost = option.cost * Math.pow(1 + inflationRate, year);
                     } else if ((option.type === 'HYBRID' || option.type === 'GEO') && year > 0 && year % geothermalLifespan === 0) {
                         // *** THIS IS THE KEY CHANGE ***
                         // Use the new fixed replacement cost from the input field
                         const futureReplacementCost = getVal('geoReplacementCost');
                         replacementCost = futureReplacementCost * Math.pow(1 + inflationRate, year);
                     }

                     if (replacementCost > 0) {
                         cumulativeCost += replacementCost;
                         yearlyData.push({ year: year, cost: cumulativeCost });
                     }
                 }
                
                 projectionData.push({
                     name: option.name,
                     data: yearlyData,
                     type: option.type,
                     color: option.type === 'HP' ? 'hsl(' + (210 + (heatPumpResults.indexOf(option) * 30)) + ', 70%, 50%)' : 
                            option.type === 'HYBRID' ? 'hsl(' + (270 + (hybridResults.indexOf(option) * 30)) + ', 70%, 50%)' :
                            'hsl(' + (120 + (geothermalResults.indexOf(option) * 40)) + ', 70%, 45%)'
                 });
             });
            
             if (projectionData.length === 0) return;
            
             const maxCost = Math.max(...projectionData.flatMap(p => p.data.map(d => d.cost)));
             const maxYear = years;
            
             const margin = { top: 40, right: 20, bottom: 80, left: 60 };
             const chartWidth = chartContainer.clientWidth - margin.left - margin.right;
             const chartHeight = chartContainer.clientHeight - margin.top - margin.bottom;
            
             const xScale = (year) => margin.left + (year / maxYear) * chartWidth;
             const yScale = (cost) => margin.top + chartHeight - (cost / maxCost) * chartHeight;
            
             ctx.strokeStyle = '#e0e0e0';
             ctx.lineWidth = 0.5;

             for (let year = 0; year <= maxYear; year += 5) {
                 const x = xScale(year);
                 ctx.beginPath();
                 ctx.moveTo(x, margin.top);
                 ctx.lineTo(x, margin.top + chartHeight);
                 ctx.strokeStyle = (year % 10 === 0) ? '#d0d0d0' : '#e0e0e0';
                 ctx.stroke();
             }
            
             const costStep = Math.ceil(maxCost / 8 / 10000) * 10000;
             for (let cost = 0; cost <= maxCost; cost += costStep) {
                 if(cost === 0) continue;
                 const y = yScale(cost);
                 ctx.beginPath();
                 ctx.moveTo(margin.left, y);
                 ctx.lineTo(margin.left + chartWidth, y);
                 ctx.stroke();
             }
            
             ctx.strokeStyle = '#333';
             ctx.lineWidth = 1;
            
             ctx.beginPath();
             ctx.moveTo(margin.left, margin.top + chartHeight);
             ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
             ctx.stroke();
            
             ctx.beginPath();
             ctx.moveTo(margin.left, margin.top);
             ctx.lineTo(margin.left, margin.top + chartHeight);
             ctx.stroke();
            
             function drawMarker(ctx, x, y, type, color, size = 3) {
                 ctx.fillStyle = color;
                 ctx.strokeStyle = color;
                 ctx.lineWidth = 1;
                 switch(type) {
                     case 'circle': ctx.beginPath(); ctx.arc(x, y, size, 0, 2 * Math.PI); ctx.fill(); break;
                     case 'square': ctx.fillRect(x - size, y - size, size * 2, size * 2); break;
                     case 'diamond': ctx.save(); ctx.translate(x,y); ctx.rotate(Math.PI/4); ctx.fillRect(-size, -size, size * 2, size * 2); ctx.restore(); break;
                 }
             }

             const markerTypes = ['circle', 'square', 'diamond'];
             projectionData.forEach((option, index) => {
                 const markerType = markerTypes[index % markerTypes.length];
                
                 ctx.strokeStyle = option.color;
                 ctx.lineWidth = option.type === 'GEO' ? 2.5 : option.type === 'HYBRID' ? 2 : 1.5;
                
                 if (option.type === 'HP') ctx.setLineDash([5, 3]);
                 else if (option.type === 'HYBRID') ctx.setLineDash([10, 3, 3, 3]);
                 else ctx.setLineDash([]);
                
                 ctx.beginPath();
                 option.data.forEach((point, i) => {
                     const x = xScale(point.year);
                     const y = yScale(point.cost);
                     if (i === 0) ctx.moveTo(x, y);
                     else ctx.lineTo(x, y);
                 });
                 ctx.stroke();
                 ctx.setLineDash([]);
                
                 option.data.forEach((point) => {
                     if (point.year > 0 && point.year % 5 === 0) {
                         drawMarker(ctx, xScale(point.year), yScale(point.cost), markerType, option.color);
                     }
                 });
             });
            
             ctx.fillStyle = '#333';
             ctx.font = '11px Segoe UI';
             ctx.textAlign = 'center';
             for (let year = 0; year <= maxYear; year += 5) {
                 ctx.font = (year % 10 === 0) ? 'bold 11px Segoe UI' : '11px Segoe UI';
                 ctx.fillText(year.toString(), xScale(year), margin.top + chartHeight + 15);
             }
            
             ctx.textAlign = 'right';
             for (let cost = 0; cost <= maxCost; cost += costStep) {
                 if (cost > 0) ctx.fillText('$' + Math.round(cost / 1000) + 'k', margin.left - 8, yScale(cost) + 4);
             }
            
             ctx.font = '12px Segoe UI';
             ctx.textAlign = 'center';
             ctx.fillText('Years', margin.left + chartWidth/2, chartContainer.clientHeight - 25);
            
             ctx.save();
             ctx.translate(15, margin.top + chartHeight/2);
             ctx.rotate(-Math.PI/2);
             ctx.fillText('Cumulative Total Cost', 0, 0);
             ctx.restore();
            
             ctx.font = 'bold 14px Segoe UI';
             ctx.textAlign = 'center';
             ctx.fillText('30-Year Total Cost Projection (Including Replacements & Inflation)', margin.left + chartWidth/2, 20);
                                    
             const legendY_start = chartContainer.clientHeight - 15;
             let legendX = margin.left;
             let legendY = legendY_start;

             projectionData.forEach((option, index) => {
                 const markerType = markerTypes[index % markerTypes.length];
                
                 ctx.strokeStyle = option.color;
                 ctx.lineWidth = option.type === 'GEO' ? 2.5 : option.type === 'HYBRID' ? 2 : 1.5;
                
                 if (option.type === 'HP') ctx.setLineDash([5, 3]);
                 else if (option.type === 'HYBRID') ctx.setLineDash([10, 3, 3, 3]);
                 else ctx.setLineDash([]);
                
                 ctx.beginPath();
                 ctx.moveTo(legendX, legendY);
                 ctx.lineTo(legendX + 25, legendY);
                 ctx.stroke();
                 ctx.setLineDash([]);
                
                 drawMarker(ctx, legendX + 12.5, legendY, markerType, option.color);
                
                 ctx.fillStyle = '#333';
                 ctx.font = '11px Segoe UI';
                 ctx.textAlign = 'left';
                 ctx.fillText(option.name, legendX + 30, legendY + 4);
                
                 const textWidth = ctx.measureText(option.name).width;
                 legendX += 30 + textWidth + 15;
                
                 if (legendX > chartContainer.clientWidth - 100 && index < projectionData.length -1) {
                     legendX = margin.left;
                     legendY += 20;
                 }
             });
        }
        
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('fileStatus');
            const errorEl = document.getElementById('fileError');
            
            const el = isError ? errorEl : statusEl;
            el.textContent = message;
            el.style.display = 'block';
            (isError ? statusEl : errorEl).style.display = 'none';
            
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }

        // *** MODIFIED FUNCTION ***
        // Updated template to use EER/COP for Geothermal examples.
        function downloadTemplate() {
            const template = `Type,Name,Cost,Rating1,Rating2
# Enter Heat Pump quotes like this:
HeatPump,My Heat Pump Quote,10000,15,8.2
# Enter Geothermal quotes like this (use EER/COP for Rating1/Rating2):
Hybrid,My Hybrid Quote,35000,20,4.5
Geothermal,My Full Geothermal Quote,50000,22,5.0`;
            
            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hvac_vendor_template.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Template downloaded! Fill in your actual vendor quotes.');
        }

        // *** MODIFIED FUNCTION ***
        // Updated example data to use more realistic EER/COP values for geothermal.
        function loadExampleData() {
            const exampleData = `Type,Name,Cost,Rating1,Rating2
HeatPump,Heat Pump Haller,15401,14.5,7.8
HeatPump,Heat Pump Grainger,9500,15.2,8.5
Hybrid,Hybrid Geothermal,42000,21.0,4.6
Geothermal,Full Geo Haller,60000,24.0,5.1
Geothermal,Full Geo Morrison,51952,22.0,4.8`;
            
            try {
                parseVendorData(exampleData);
                showStatus('Example data loaded with accurate geo ratings!');
            } catch (error) {
                showStatus('Error loading example data: ' + error.message, true);
            }
        }

        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseVendorData(e.target.result);
                } catch (error) {
                    showStatus('Error reading file: ' + error.message, true);
                }
            };
            reader.readAsText(file);
        }

        // *** MODIFIED FUNCTION ***
        // Updated to handle generic 'Rating1' and 'Rating2' from CSV.
        function parseVendorData(text) {
            try {
                const lines = text.split('\n').map(line => line.trim()).filter(line => line && !line.startsWith('#'));
                if (lines.length === 0) throw new Error('File is empty or only contains comments');
                
                const hasHeader = lines[0].toLowerCase().includes('type');
                const dataLines = hasHeader ? lines.slice(1) : lines;
                if (dataLines.length === 0) throw new Error('No data rows found');

                initializeVendors(); // Clear existing vendors
                
                let hpCount = 0, hybridCount = 0, geoCount = 0;
                let validRows = 0;
                
                dataLines.forEach((line, index) => {
                    if (!line.trim()) return;
                    
                    const parts = line.split(',').map(part => part.trim().replace(/"/g, ''));
                    if (parts.length < 5) {
                        console.warn(`Line ${index + 2}: Skipping, expected 5 columns, got ${parts.length}`);
                        return;
                    }
                    
                    const [type, name, cost, rating1, rating2] = parts;
                    const costNum = parseFloat(cost);
                    const r1Num = parseFloat(rating1);
                    const r2Num = parseFloat(rating2);
                    
                    if (isNaN(costNum) || isNaN(r1Num) || isNaN(r2Num) || !name.trim()) {
                        console.warn(`Line ${index + 2}: Skipping, invalid data`);
                        return;
                    }
                    
                    validRows++;
                    const typeLower = type.toLowerCase();

                    if (typeLower.includes('heat') || typeLower.includes('pump')) {
                        hpCount++;
                        addVendorFromData('hp', hpCount, name, costNum, r1Num, r2Num);
                    } else if (typeLower.includes('hybrid')) {
                        hybridCount++;
                        addVendorFromData('hybrid', hybridCount, name, costNum, r1Num, r2Num);
                    } else if (typeLower.includes('geo')) {
                        geoCount++;
                        addVendorFromData('geo', geoCount, name, costNum, r1Num, r2Num);
                    } else {
                        console.warn(`Line ${index + 2}: Unknown type "${type}"`);
                    }
                });
                
                if (validRows === 0) throw new Error('No valid data rows found');
                
                setTimeout(() => calculateAll(), 100);
                showStatus(`Successfully loaded ${hpCount} heat pump, ${hybridCount} hybrid, and ${geoCount} geothermal options.`);
            } catch (error) {
                showStatus('Error parsing file: ' + error.message, true);
            }
        }

        function addVendorFromData(type, id, name, cost, r1, r2) {
            const containers = {
                'hp': 'heatPumpVendors', 'hybrid': 'hybridVendors', 'geo': 'geothermalVendors'
            };
            const container = document.getElementById(containers[type]);
            const vendorHTML = createVendorHTML(type, id, name, cost, r1, r2);
            container.insertAdjacentHTML('beforeend', vendorHTML);
            
            if (type === 'hp') heatPumpCounter = Math.max(heatPumpCounter, id);
            else if (type === 'hybrid') hybridCounter = Math.max(hybridCounter, id);
            else geothermalCounter = Math.max(geothermalCounter, id);
        }
        
        function exportData() {
             const data = [];
             data.push(['Type', 'Name', 'Cost', 'Rating1', 'Rating2']);
            
             const collectData = (counter, type) => {
                 for (let i = 1; i <= counter; i++) {
                     const element = document.getElementById(`${type}Vendor${i}`);
                     if (element) {
                         const name = getText(`${type}Name${i}`);
                         const cost = getVal(`${type}Cost${i}`);
                         if (name && cost > 0) {
                             let r1, r2, typeLabel;
                             if (type === 'hp') {
                                 r1 = getVal(`hpSEER${i}`);
                                 r2 = getVal(`hpHSPF${i}`);
                                 typeLabel = 'HeatPump';
                             } else {
                                 r1 = getVal(`${type}EER${i}`);
                                 r2 = getVal(`${type}COP${i}`);
                                 typeLabel = type === 'hybrid' ? 'Hybrid' : 'Geothermal';
                             }
                             data.push([typeLabel, name, cost, r1, r2]);
                         }
                     }
                 }
             };
            
             collectData(heatPumpCounter, 'hp');
             collectData(hybridCounter, 'hybrid');
             collectData(geothermalCounter, 'geo');
            
             const csv = data.map(row => row.join(',')).join('\n');
             const blob = new Blob([csv], { type: 'text/csv' });
             const url = window.URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = 'hvac_analysis_data.csv';
             a.click();
             window.URL.revokeObjectURL(url);
            
             showStatus('Analysis data exported successfully!');
        }
        
        window.onload = function() {
            setTimeout(() => {
                initializeVendors();
                calculateAll();
            }, 200);
        };
    </script>
</body>
</html>
```