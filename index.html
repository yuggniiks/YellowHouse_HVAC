<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Analysis - Dynamic Vendor Comparison</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2em;
            font-weight: 300;
        }
        
        .header p {
            margin: 8px 0 0 0;
            opacity: 0.9;
            font-size: 1em;
        }
        
        .content {
            padding: 20px;
        }
        
        .section {
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 18px;
            border-left: 4px solid #3498db;
        }
        
        .section h2 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .compact-section {
            margin-bottom: 15px;
            padding: 12px;
        }
        
        .compact-section h2 {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .compact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .vendor-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .vendor-option h4 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            font-size: 1em;
        }
        
        .vendor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }
        
        .input-group {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #555;
            font-size: 12px;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 6px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .input-group small {
            display: block;
            color: #666;
            font-size: 10px;
            margin-top: 2px;
        }
        
        .remove-vendor {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        
        .add-vendor-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 8px 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 12px;
        }
        
        .results-table th {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
        }
        
        .results-table td {
            padding: 6px;
            border-bottom: 1px solid #eee;
            font-size: 11px;
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 15px 0;
            display: block;
            width: 100%;
        }
        
        .toggle-debug {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }
        
        .summary-card h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 0.9em;
        }
        
        .summary-card .value {
            font-size: 1.3em;
            font-weight: bold;
            color: #3498db;
            word-wrap: break-word;
        }
        
        .note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            color: #856404;
            font-size: 12px;
        }

        .debug-section {
            background: #f0f8ff;
            border: 1px solid #b0d4f1;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }

        .decision-flow {
            background: #e8f5e8;
            border: 2px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
        }

        .decision-flow h3 {
            color: #27ae60;
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .incremental-highlight {
            background: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 4px solid #ffc107;
            font-size: 12px;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .file-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-block;
            text-decoration: none;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }
        
        .file-btn:hover {
            transform: translateY(-1px);
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
        }
        
        .file-status {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 8px;
            margin: 10px 0;
            color: #155724;
            font-size: 12px;
            display: none;
        }
        
        .file-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 8px;
            margin: 10px 0;
            color: #721c24;
            font-size: 12px;
            display: none;
        }

        @media (max-width: 1200px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>YellowHouse HVAC Decision Analysis</h1>
            <p>Dynamic Vendor Comparison - Baseline Repair vs. Premium Upgrade</p>
        </div>
        
        <div class="content">
            <div class="decision-flow">
                <h3>üéØ Decision Framework</h3>
                <strong>Step 1:</strong> Compare all heat pump vendors to choose your baseline repair<br>
                <strong>Step 2:</strong> Evaluate if any geothermal option justifies the extra investment<br>
                <strong>Add Vendors:</strong> Use "Add Another Option" to compare unlimited quotes<br>
                <strong>Import/Export:</strong> Load vendor data from CSV/TXT files or save your analysis
                
                <!-- File Import/Export Controls -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #27ae60;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <label for="fileInput" class="file-btn">üìÅ Load Vendor File</label>
                        <input type="file" id="fileInput" accept=".csv,.txt" style="display: none;" onchange="loadFile(event)">
                        <small style="display: block; margin-top: 5px;">Upload CSV with your vendor quotes</small>
                    </div>
                    <div>
                        <button class="file-btn" onclick="exportData()">üíæ Save Vendor Data</button>
                        <small style="display: block; margin-top: 5px;">Download your current vendor list as CSV</small>
                    </div>
                    <div>
                        <button class="file-btn" onclick="downloadTemplate()">üìã Get Blank Template</button>
                        <small style="display: block; margin-top: 5px;">Download empty CSV template to fill in</small>
                    </div>
                    <div>
                        <button class="file-btn" onclick="loadExampleData()">üéØ Load Example Data</button>
                        <small style="display: block; margin-top: 5px;">See analysis with real vendor quotes</small>
                    </div>
                </div>
                    <div id="fileStatus" class="file-status"></div>
                    <div id="fileError" class="file-error"></div>
                </div>
            </div>

            <!-- Financial & Current System Inputs - Side by side -->
            <div class="two-column">
                <div class="section compact-section">
                    <h2>üí∞ Financial Parameters</h2>
                    <div class="compact-grid">
                        <div class="input-group">
                            <label for="electricityRate">Electricity Rate ($/kWh)</label>
                            <input type="number" id="electricityRate" value="0.169" step="0.001" onchange="calculateAll()">
                            <small>Current total rate</small>
                        </div>
                        <div class="input-group">
                            <label for="inflationRate">Annual Rate Increase (%)</label>
                            <input type="number" id="inflationRate" value="3.5" step="0.1" onchange="calculateAll()">
                            <small>Historical 3-4%</small>
                        </div>
                        <div class="input-group">
                            <label for="discountRate">Discount Rate (%)</label>
                            <input type="number" id="discountRate" value="3" step="0.1" onchange="calculateAll()">
                            <small>Time value of money</small>
                        </div>
                        <div class="input-group">
                            <label for="taxCredit">Tax Credit (%)</label>
                            <input type="number" id="taxCredit" value="30" onchange="calculateAll()">
                            <small>Geothermal only</small>
                        </div>
                    </div>
                </div>

                <div class="section compact-section">
                    <h2>üè† Current System</h2>
                    <div class="compact-grid">
                        <div class="input-group">
                            <label for="currentAnnualCost">Annual Energy Cost ($)</label>
                            <input type="number" id="currentAnnualCost" value="3443" onchange="calculateAll()">
                            <small>Current bill</small>
                        </div>
                        <div class="input-group">
                            <label for="brokenSystemPenalty">Broken System Extra ($)</label>
                            <input type="number" id="brokenSystemPenalty" value="800" onchange="calculateAll()">
                            <small>Upstairs broken cost</small>
                        </div>
                        <div class="input-group">
                            <label for="currentSEER">Current Avg SEER</label>
                            <input type="number" id="currentSEER" value="11.75" step="0.1" onchange="calculateAll()">
                            <small>Mixed system avg</small>
                        </div>
                        <div class="input-group">
                            <label for="currentHSPF">Current Avg HSPF</label>
                            <input type="number" id="currentHSPF" value="7.4" step="0.1" onchange="calculateAll()">
                            <small>Mixed system avg</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weather Impact - Compact -->
            <div class="section compact-section">
                <h2>üå°Ô∏è Weather Impact (Heat Pumps Only)</h2>
                <div class="compact-grid">
                    <div class="input-group">
                        <label for="emergencyHeatDays">Emergency Heat Days</label>
                        <input type="number" id="emergencyHeatDays" value="35" onchange="calculateAll()">
                        <small>Days below 20¬∞F</small>
                    </div>
                    <div class="input-group">
                        <label for="emergencyHeatCost">Emergency Heat Cost ($/day)</label>
                        <input type="number" id="emergencyHeatCost" value="12" onchange="calculateAll()">
                        <small>Extra daily cost</small>
                    </div>
                    <div class="input-group">
                        <label for="hotDayPenalty">Hot Day Loss (%)</label>
                        <input type="number" id="hotDayPenalty" value="15" onchange="calculateAll()">
                        <small>Efficiency loss 90¬∞F+</small>
                    </div>
                    <div class="input-group">
                        <label for="hotDaysPerYear">Hot Days/Year</label>
                        <input type="number" id="hotDaysPerYear" value="22" onchange="calculateAll()">
                        <small>Central PA average</small>
                    </div>
                </div>
            </div>

            <!-- Vendor Options - Side by side -->
            <div class="two-column">
                <!-- Baseline Heat Pump Options -->
                <div class="section baseline-section compact-section">
                    <h2>üîß Heat Pump Options (Baseline)</h2>
                    <div style="background: #e8f5e8; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 12px;">
                        <strong>Required:</strong> Replace broken upstairs unit
                    </div>
                    
                    <div id="heatPumpVendors">
                        <!-- Initial vendors will be inserted here -->
                    </div>
                    
                    <button class="add-vendor-btn" onclick="addHeatPumpVendor()">
                        ‚ûï Add Heat Pump Quote
                    </button>
                </div>

                <!-- Premium Geothermal Options -->
                <div class="section upgrade-section compact-section">
                    <h2>‚ö° Geothermal Options (Upgrade)</h2>
                    <div style="background: #ffe6e6; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 12px;">
                        <strong>Premium:</strong> Full system replacement
                    </div>
                    
                    <div id="geothermalVendors">
                        <!-- Initial vendors will be inserted here -->
                    </div>
                    
                    <button class="add-vendor-btn" onclick="addGeothermalVendor()">
                        ‚ûï Add Geothermal Quote
                    </button>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateAll()">üîÑ Calculate Analysis</button>

            <!-- Debug Section -->
            <button class="toggle-debug" onclick="toggleDebug()">Toggle Debug Info</button>
            <div class="debug-section" id="debugSection" style="display: none;">
                <strong>Calculation Details:</strong><br>
                <div id="debugOutput"></div>
            </div>

            <!-- Baseline Heat Pump Comparison -->
            <div class="section baseline-section">
                <h2>üîß Step 1: Choose Your Baseline Heat Pump</h2>
                <div style="margin-bottom: 15px; background: #e8f5e8; padding: 15px; border-radius: 6px; color: #2d5f2d;">
                    <strong>Baseline Comparison:</strong> All options replace only the broken upstairs unit and keep your good 2022 downstairs unit.
                </div>
                <table class="results-table baseline-table" id="baselineTable">
                    <thead>
                        <tr>
                            <th>Heat Pump Option</th>
                            <th>Installation Cost</th>
                            <th>System Efficiency</th>
                            <th>Annual Energy Cost</th>
                            <th>Annual Total Cost</th>
                            <th>Annual Savings vs Broken</th>
                        </tr>
                    </thead>
                    <tbody id="baselineBody"></tbody>
                </table>
            </div>

            <!-- Geothermal Upgrade Analysis -->
            <div class="section upgrade-section">
                <h2>‚ö° Step 2: Geothermal Upgrade Analysis</h2>
                <div class="incremental-highlight">
                    <strong>Incremental Analysis:</strong> Compares geothermal options against your best heat pump choice.
                </div>
                <table class="results-table upgrade-table" id="upgradeTable">
                    <thead>
                        <tr>
                            <th>Geothermal Option</th>
                            <th>Extra Investment</th>
                            <th>Tax Credit</th>
                            <th>Net Extra Cost</th>
                            <th>Extra Annual Savings</th>
                            <th>Simple Payback</th>
                        </tr>
                    </thead>
                    <tbody id="upgradeBody"></tbody>
                </table>
            </div>

            <!-- NPV Analysis -->
            <div class="section">
                <h2>üí∞ Net Present Value Analysis</h2>
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    <strong>Incremental NPV:</strong> Shows the value of choosing geothermal over the best heat pump option.
                    Green = geothermal upgrade pays off, Red = heat pump is better value.
                </div>
                <table class="results-table" id="npvTable">
                    <thead>
                        <tr>
                            <th>Geothermal Option</th>
                            <th>Net Extra Investment</th>
                            <th>5 Year NPV</th>
                            <th>10 Year NPV</th>
                            <th>15 Year NPV</th>
                            <th>20 Year NPV</th>
                        </tr>
                    </thead>
                    <tbody id="npvBody"></tbody>
                </table>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card baseline-card">
                    <h3>Best Heat Pump</h3>
                    <div class="value" id="bestHeatPump">-</div>
                </div>
                <div class="summary-card upgrade-card">
                    <h3>Best Geothermal Value</h3>
                    <div class="value" id="bestGeo">-</div>
                </div>
                <div class="summary-card">
                    <h3>Recommended Choice</h3>
                    <div class="value" id="recommendation">-</div>
                </div>
                <div class="summary-card">
                    <h3>Net Decision Impact</h3>
                    <div class="value" id="netImpact">-</div>
                </div>
            </div>

            <!-- 50-Year Cost Projection Graph -->
            <div class="section">
                <h2>üìà 50-Year Total Cost Projection</h2>
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    <strong>Cumulative Total Cost:</strong> Shows initial investment plus accumulated energy costs over time.
                    Watch for crossover points where geothermal systems become more cost-effective than heat pumps.
                </div>
                <div style="position: relative; height: 500px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <canvas id="costProjectionChart" style="width: 100%; height: 100%;"></canvas>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    <strong>Key Insights:</strong> Lines that cross show break-even points. Lower lines after year 20+ indicate better long-term value.
                </div>
            </div>

            <div class="note">
                <strong>Dynamic Vendor Comparison:</strong><br>
                ‚Ä¢ <strong>Unlimited Quotes:</strong> Add as many vendor options as you need for comparison<br>
                ‚Ä¢ <strong>Real-time Updates:</strong> All calculations update automatically as you add/modify vendors<br>
                ‚Ä¢ <strong>Baseline Logic:</strong> Compare heat pump repairs first, then evaluate geothermal upgrades<br>
                ‚Ä¢ <strong>Clear Recommendations:</strong> System highlights the best financial choice<br>
                ‚Ä¢ <strong>Easy Management:</strong> Remove vendors with the ‚úó button if quotes change
            </div>
        </div>
    </div>

    <script>
        let heatPumpCounter = 0;
        let geothermalCounter = 0;

        function getVal(id) {
            const element = document.getElementById(id);
            return element ? parseFloat(element.value) || 0 : 0;
        }

        function getText(id) {
            const element = document.getElementById(id);
            return element ? element.value || '' : '';
        }

        function toggleDebug() {
            const debugSection = document.getElementById('debugSection');
            debugSection.style.display = debugSection.style.display === 'none' ? 'block' : 'none';
        }

        function createVendorHTML(type, id, name, cost, seer, hspf) {
            const isRemovable = (type === 'hp' && heatPumpCounter > 2) || (type === 'geo' && geothermalCounter > 2);
            const typeLabel = type === 'hp' ? 'Heat Pump' : 'Geothermal';
            const removeButton = isRemovable ? `<button class="remove-vendor" onclick="removeVendor('${type}', ${id})" title="Remove this vendor">‚úó</button>` : '';
            
            return `
                <div class="vendor-option" id="${type}Vendor${id}">
                    ${removeButton}
                    <h4>${typeLabel} Option ${id}</h4>
                    <div class="vendor-grid">
                        <div class="input-group">
                            <label for="${type}Name${id}">Vendor/Option Name</label>
                            <input type="text" id="${type}Name${id}" value="${name}" onchange="calculateAll()">
                            <small>Custom name for this option</small>
                        </div>
                        <div class="input-group">
                            <label for="${type}Cost${id}">Total Cost ($)</label>
                            <input type="number" id="${type}Cost${id}" value="${cost}" onchange="calculateAll()">
                            <small>Total installed cost</small>
                        </div>
                        <div class="input-group">
                            <label for="${type}SEER${id}">SEER Rating</label>
                            <input type="number" id="${type}SEER${id}" value="${seer}" step="0.1" onchange="calculateAll()">
                            <small>Cooling efficiency</small>
                        </div>
                        <div class="input-group">
                            <label for="${type}HSPF${id}">HSPF Rating</label>
                            <input type="number" id="${type}HSPF${id}" value="${hspf}" step="0.1" onchange="calculateAll()">
                            <small>Heating efficiency</small>
                        </div>
                    </div>
                </div>
            `;
        }

        function addHeatPumpVendor() {
            heatPumpCounter++;
            const container = document.getElementById('heatPumpVendors');
            const vendorHTML = createVendorHTML('hp', heatPumpCounter, `Heat Pump Option ${heatPumpCounter}`, 10000, 15, 8);
            container.insertAdjacentHTML('beforeend', vendorHTML);
            calculateAll();
        }

        function addGeothermalVendor() {
            geothermalCounter++;
            const container = document.getElementById('geothermalVendors');
            const vendorHTML = createVendorHTML('geo', geothermalCounter, `Geothermal Option ${geothermalCounter}`, 40000, 18, 9);
            container.insertAdjacentHTML('beforeend', vendorHTML);
            calculateAll();
        }

        function removeVendor(type, id) {
            const vendorElement = document.getElementById(`${type}Vendor${id}`);
            if (vendorElement) {
                vendorElement.remove();
                calculateAll();
            }
        }

        function initializeVendors() {
            // Start completely blank - no default vendors
            // Users will add vendors manually or load from file
            const heatPumpContainer = document.getElementById('heatPumpVendors');
            const geothermalContainer = document.getElementById('geothermalVendors');
            heatPumpContainer.innerHTML = '';
            geothermalContainer.innerHTML = '';
            heatPumpCounter = 0;
            geothermalCounter = 0;
        }

        function getHeatPumpOptions() {
            const options = [];
            for (let i = 1; i <= heatPumpCounter; i++) {
                const element = document.getElementById(`hpVendor${i}`);
                if (element) {
                    options.push({
                        id: i,
                        name: getText(`hpName${i}`),
                        cost: getVal(`hpCost${i}`),
                        seer: getVal(`hpSEER${i}`),
                        hspf: getVal(`hpHSPF${i}`),
                        maintenance: 300,
                        type: 'HP'
                    });
                }
            }
            return options;
        }

        function getGeothermalOptions() {
            const options = [];
            for (let i = 1; i <= geothermalCounter; i++) {
                const element = document.getElementById(`geoVendor${i}`);
                if (element) {
                    options.push({
                        id: i,
                        name: getText(`geoName${i}`),
                        cost: getVal(`geoCost${i}`),
                        seer: getVal(`geoSEER${i}`),
                        hspf: getVal(`geoHSPF${i}`),
                        maintenance: 150,
                        type: 'GEO'
                    });
                }
            }
            return options;
        }

        function calculateNewEnergyCost(newSEER, newHSPF, type) {
            const currentEnergyCost = getVal('currentAnnualCost');
            const currentSEER = getVal('currentSEER');
            const currentHSPF = getVal('currentHSPF');
            
            let effectiveSEER, effectiveHSPF;
            
            if (type === 'HP') {
                // Heat pump: mixed system (upstairs replacement + existing downstairs)
                const downstairsSEER = 14.5; // 2022 unit
                const downstairsHSPF = 8.35; // 2022 unit
                
                // Mixed system: 65% upstairs load, 35% downstairs load
                effectiveSEER = (0.65 * newSEER) + (0.35 * downstairsSEER);
                effectiveHSPF = (0.65 * newHSPF) + (0.35 * downstairsHSPF);
            } else {
                // Geothermal - full system replacement
                effectiveSEER = newSEER;
                effectiveHSPF = newHSPF;
            }
            
            // Calculate efficiency improvements
            const seerImprovement = effectiveSEER / currentSEER;
            const hspfImprovement = effectiveHSPF / currentHSPF;
            
            // Weight by seasonal usage (60% cooling, 40% heating in Central PA)
            const overallEfficiencyFactor = (0.6 * seerImprovement) + (0.4 * hspfImprovement);
            
            // Base energy cost from efficiency improvement
            let newEnergyCost = currentEnergyCost / overallEfficiencyFactor;
            
            // Add weather penalties for heat pumps only
            if (type === 'HP') {
                const emergencyHeatDays = getVal('emergencyHeatDays');
                const emergencyHeatCost = getVal('emergencyHeatCost');
                const hotDayPenalty = getVal('hotDayPenalty') / 100;
                const hotDaysPerYear = getVal('hotDaysPerYear');
                
                // Emergency heat penalty (winter)
                const winterPenalty = emergencyHeatDays * emergencyHeatCost;
                
                // Hot day efficiency loss penalty (summer) 
                const summerPenalty = (currentEnergyCost * 0.6) * hotDayPenalty * (hotDaysPerYear / 120); // 120 = typical cooling days
                
                newEnergyCost += winterPenalty + summerPenalty;
            }
            
            return newEnergyCost;
        }

        function calculateAll() {
            const taxCreditRate = getVal('taxCredit') / 100;
            const discountRate = getVal('discountRate') / 100;
            const inflationRate = getVal('inflationRate') / 100;
            const currentTotalCost = getVal('currentAnnualCost') + getVal('brokenSystemPenalty');
            
            const baselineBody = document.getElementById('baselineBody');
            const upgradeBody = document.getElementById('upgradeBody');
            const npvBody = document.getElementById('npvBody');
            const debugOutput = document.getElementById('debugOutput');
            
            // Clear existing content
            baselineBody.innerHTML = '';
            upgradeBody.innerHTML = '';
            npvBody.innerHTML = '';
            
            let debugText = `Current total annual cost (broken system): ${currentTotalCost.toLocaleString()}<br>`;
            debugText += `Discount rate: ${(discountRate * 100).toFixed(1)}%, Inflation rate: ${(inflationRate * 100).toFixed(1)}%<br><br>`;
            
            const heatPumpResults = [];
            const geothermalResults = [];
            
            // Calculate heat pump baseline options
            debugText += `<strong>=== BASELINE HEAT PUMP OPTIONS ===</strong><br>`;
            const heatPumpOptions = getHeatPumpOptions();
            
            heatPumpOptions.forEach(option => {
                if (option.cost > 0 && option.name.trim()) { // Only include valid options
                    const newEnergyCost = calculateNewEnergyCost(option.seer, option.hspf, option.type);
                    const totalNewAnnualCost = newEnergyCost + option.maintenance;
                    const annualSavings = currentTotalCost - totalNewAnnualCost;
                    
                    debugText += `${option.name}: Cost ${option.cost.toLocaleString()}, `;
                    debugText += `Energy ${newEnergyCost.toFixed(0)}, Total Annual ${totalNewAnnualCost.toFixed(0)}, `;
                    debugText += `Savings ${annualSavings.toFixed(0)}<br>`;
                    
                    heatPumpResults.push({
                        name: option.name,
                        cost: option.cost,
                        seer: option.seer,
                        hspf: option.hspf,
                        energyCost: newEnergyCost,
                        totalAnnualCost: totalNewAnnualCost,
                        annualSavings: annualSavings
                    });
                }
            });
            
            // Find best heat pump option (lowest total cost)
            if (heatPumpResults.length === 0) {
                debugText += `<br><strong>No valid heat pump options found</strong><br><br>`;
                debugOutput.innerHTML = debugText;
                generateCostProjectionChart([], []);
                return;
            }
            
            const bestHeatPump = heatPumpResults.reduce((best, current) => 
                current.totalAnnualCost < best.totalAnnualCost ? current : best
            );
            
            debugText += `<br><strong>Best Heat Pump Baseline:</strong> ${bestHeatPump.name} with ${bestHeatPump.totalAnnualCost.toFixed(0)} annual cost<br><br>`;
            
            // Calculate geothermal options vs best heat pump
            debugText += `<strong>=== GEOTHERMAL UPGRADE ANALYSIS ===</strong><br>`;
            const geothermalOptions = getGeothermalOptions();
            
            geothermalOptions.forEach(option => {
                if (option.cost > 0 && option.name.trim()) { // Only include valid options
                    const taxCredit = option.cost * taxCreditRate;
                    const netCost = option.cost - taxCredit;
                    const newEnergyCost = calculateNewEnergyCost(option.seer, option.hspf, option.type);
                    const totalNewAnnualCost = newEnergyCost + option.maintenance;
                    
                    // Calculate incremental values vs best heat pump
                    const extraInvestment = option.cost - bestHeatPump.cost;
                    const netExtraInvestment = netCost - bestHeatPump.cost;
                    const extraAnnualSavings = bestHeatPump.totalAnnualCost - totalNewAnnualCost;
                    const simplePayback = extraAnnualSavings > 0 ? netExtraInvestment / extraAnnualSavings : 999;
                    
                    debugText += `${option.name}: Extra cost ${extraInvestment.toLocaleString()} (net: ${netExtraInvestment.toLocaleString()}), `;
                    debugText += `Extra savings ${extraAnnualSavings.toFixed(0)}/yr, Payback ${simplePayback.toFixed(1)} years<br>`;
                    
                    // Calculate incremental NPV
                    let cumulativeNPV = -netExtraInvestment;
                    const npvAtIntervals = {};
                    
                    for (let year = 1; year <= 20; year++) {
                        const inflatedSavings = extraAnnualSavings * Math.pow(1 + inflationRate, year - 1);
                        const presentValue = inflatedSavings / Math.pow(1 + discountRate, year);
                        cumulativeNPV += presentValue;
                        
                        if ([5, 10, 15, 20].includes(year)) {
                            npvAtIntervals[year] = cumulativeNPV;
                        }
                    }
                    
                    geothermalResults.push({
                        name: option.name,
                        cost: option.cost,
                        netCost: netCost,
                        taxCredit: taxCredit,
                        seer: option.seer,
                        hspf: option.hspf,
                        energyCost: newEnergyCost,
                        totalAnnualCost: totalNewAnnualCost,
                        extraInvestment: extraInvestment,
                        netExtraInvestment: netExtraInvestment,
                        extraAnnualSavings: extraAnnualSavings,
                        simplePayback: simplePayback,
                        npv5yr: npvAtIntervals[5],
                        npv10yr: npvAtIntervals[10],
                        npv15yr: npvAtIntervals[15],
                        npv20yr: npvAtIntervals[20]
                    });
                }
            });
            
            debugOutput.innerHTML = debugText;
            
            // Helper functions
            const formatCurrency = (val) => val.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
            const formatNPV = (value) => {
                const color = value >= 0 ? '#27ae60' : '#e74c3c';
                return `<span style="color:${color}; font-weight:bold;">${formatCurrency(value)}</span>`;
            };
            const formatPayback = (years) => {
                if (years > 50) return 'Never';
                return `${years.toFixed(1)} years`;
            };
            
            // Populate baseline heat pump table
            heatPumpResults.forEach((result, index) => {
                const row = baselineBody.insertRow();
                row.innerHTML = `
                    <td><strong>${result.name}</strong></td>
                    <td>${formatCurrency(result.cost)}</td>
                    <td>${result.seer} SEER / ${result.hspf} HSPF</td>
                    <td>${formatCurrency(result.energyCost)}</td>
                    <td>${formatCurrency(result.totalAnnualCost)}</td>
                    <td><strong>${formatCurrency(result.annualSavings)}</strong></td>
                `;
                
                // Highlight best option
                if (result.name === bestHeatPump.name) {
                    row.classList.add('highlight-best');
                }
            });
            
            // Populate geothermal upgrade table
            geothermalResults.forEach((result) => {
                const row = upgradeBody.insertRow();
                row.innerHTML = `
                    <td><strong>${result.name}</strong></td>
                    <td>${formatCurrency(result.extraInvestment)}</td>
                    <td>${formatCurrency(result.taxCredit)}</td>
                    <td>${formatCurrency(result.netExtraInvestment)}</td>
                    <td><strong>${formatCurrency(result.extraAnnualSavings)}</strong></td>
                    <td>${formatPayback(result.simplePayback)}</td>
                `;
            });
            
            // Populate NPV table
            geothermalResults.forEach((result) => {
                const row = npvBody.insertRow();
                row.innerHTML = `
                    <td><strong>${result.name}</strong></td>
                    <td>${formatCurrency(result.netExtraInvestment)}</td>
                    <td>${formatNPV(result.npv5yr)}</td>
                    <td>${formatNPV(result.npv10yr)}</td>
                    <td>${formatNPV(result.npv15yr)}</td>
                    <td>${formatNPV(result.npv20yr)}</td>
                `;
            });
            
            // Update summary cards
            let bestGeo = null;
            if (geothermalResults.length > 0) {
                bestGeo = geothermalResults.reduce((best, current) => 
                    current.npv20yr > best.npv20yr ? current : best
                );
            }
            
            // Determine recommendation
            let recommendation = bestHeatPump.name;
            let netImpact = 'Baseline Choice';
            
            if (bestGeo && bestGeo.npv20yr > 0) {
                recommendation = bestGeo.name;
                netImpact = formatCurrency(bestGeo.npv20yr);
            }
            
            document.getElementById('bestHeatPump').textContent = bestHeatPump.name;
            document.getElementById('bestGeo').textContent = bestGeo ? bestGeo.name : 'None viable';
            document.getElementById('recommendation').textContent = recommendation;
            document.getElementById('netImpact').textContent = netImpact;
            
            // Generate 50-year cost projection chart
            generateCostProjectionChart(heatPumpResults, geothermalResults);
        }
        
        function generateCostProjectionChart(heatPumpResults, geothermalResults) {
            const canvas = document.getElementById('costProjectionChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const canvasRect = canvas.getBoundingClientRect();
            
            // Set canvas size to match display size
            canvas.width = canvasRect.width;
            canvas.height = canvasRect.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (heatPumpResults.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Add vendor options to see cost projection', canvas.width/2, canvas.height/2);
                return;
            }
            
            const inflationRate = getVal('inflationRate') / 100;
            const years = 50;
            
            // Calculate cumulative costs for all options over 50 years
            const allOptions = [...heatPumpResults, ...geothermalResults];
            const projectionData = [];
            
            allOptions.forEach(option => {
                const yearlyData = [];
                let cumulativeCost = option.cost; // Start with initial investment
                yearlyData.push({ year: 0, cost: cumulativeCost });
                
                for (let year = 1; year <= years; year++) {
                    // Calculate inflated annual operating cost for this year
                    const inflatedAnnualCost = option.totalAnnualCost * Math.pow(1 + inflationRate, year - 1);
                    cumulativeCost += inflatedAnnualCost;
                    yearlyData.push({ year: year, cost: cumulativeCost });
                }
                
                projectionData.push({
                    name: option.name,
                    data: yearlyData,
                    isGeothermal: geothermalResults.includes(option),
                    color: geothermalResults.includes(option) ? 
                        'hsl(' + (120 + (geothermalResults.indexOf(option) * 40)) + ', 70%, 45%)' : // Green family for geothermal
                        'hsl(' + (210 + (heatPumpResults.indexOf(option) * 30)) + ', 70%, 50%)'      // Blue family for heat pumps
                });
            });
            
            if (projectionData.length === 0) return;
            
            // Find data ranges
            const maxCost = Math.max(...projectionData.flatMap(p => p.data.map(d => d.cost)));
            const maxYear = years;
            
            // Chart dimensions
            const margin = { top: 40, right: 20, bottom: 80, left: 100 };
            const chartWidth = canvas.width - margin.left - margin.right;
            const chartHeight = canvas.height - margin.top - margin.bottom;
            
            // Scaling functions
            const xScale = (year) => margin.left + (year / maxYear) * chartWidth;
            const yScale = (cost) => margin.top + (1 - cost / maxCost) * chartHeight;
            
            // Draw grid lines
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;

            // Vertical grid lines (every 5 years)
            for (let year = 0; year <= maxYear; year += 5) {
                const x = xScale(year);
                ctx.beginPath();
                ctx.moveTo(x, margin.top);
                ctx.lineTo(x, margin.top + chartHeight);
                
                // Make every 10 year line slightly darker
                if (year % 10 === 0) {
                    ctx.strokeStyle = '#d0d0d0';
                    ctx.lineWidth = 1.5;
                } else {
                    ctx.strokeStyle = '#e0e0e0';
                    ctx.lineWidth = 1;
                }
                ctx.stroke();
}
            
            // Horizontal grid lines
            const costStep = Math.ceil(maxCost / 8 / 50000) * 50000; // Round to nearest 50k
            for (let cost = 0; cost <= maxCost; cost += costStep) {
                const y = yScale(cost);
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(margin.left + chartWidth, y);
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            
            // X-axis
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top + chartHeight);
            ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
            ctx.stroke();
            
            // Y-axis
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, margin.top + chartHeight);
            ctx.stroke();
            
// Helper function to draw markers
function drawMarker(ctx, x, y, type, color, size = 4) {
    ctx.fillStyle = color;
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    
    switch(type) {
        case 'circle':
            ctx.beginPath();
            ctx.arc(x, y, size, 0, 2 * Math.PI);
            ctx.fill();
            break;
        case 'square':
            ctx.fillRect(x - size, y - size, size * 2, size * 2);
            break;
        case 'diamond':
            ctx.beginPath();
            ctx.moveTo(x, y - size);
            ctx.lineTo(x + size, y);
            ctx.lineTo(x, y + size);
            ctx.lineTo(x - size, y);
            ctx.closePath();
            ctx.fill();
            break;
        case 'triangle':
            ctx.beginPath();
            ctx.moveTo(x, y - size);
            ctx.lineTo(x + size, y + size);
            ctx.lineTo(x - size, y + size);
            ctx.closePath();
            ctx.fill();
            break;
        case 'star':
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const angle = (i * 144 - 90) * Math.PI / 180;
                const outerRadius = size;
                const innerRadius = size * 0.4;
                
                // Outer point
                const xOuter = x + Math.cos(angle) * outerRadius;
                const yOuter = y + Math.sin(angle) * outerRadius;
                
                // Inner point
                const innerAngle = ((i + 0.5) * 144 - 90) * Math.PI / 180;
                const xInner = x + Math.cos(innerAngle) * innerRadius;
                const yInner = y + Math.sin(innerAngle) * innerRadius;
                
                if (i === 0) {
                    ctx.moveTo(xOuter, yOuter);
                } else {
                    ctx.lineTo(xOuter, yOuter);
                }
                ctx.lineTo(xInner, yInner);
            }
            ctx.closePath();
            ctx.fill();
            break;
        case 'plus':
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(x - size, y);
            ctx.lineTo(x + size, y);
            ctx.moveTo(x, y - size);
            ctx.lineTo(x, y + size);
            ctx.stroke();
            break;
    }
}

            // Draw cost projection lines
            const markerTypes = ['circle', 'square', 'diamond', 'triangle', 'star', 'plus'];
            projectionData.forEach((option, index) => {
                const markerType = markerTypes[index % markerTypes.length];
                
                ctx.strokeStyle = option.color;
                ctx.lineWidth = option.isGeothermal ? 3 : 2;
                ctx.setLineDash(option.isGeothermal ? [] : [5, 5]); // Solid for geo, dashed for HP
                
                // Draw the line
                ctx.beginPath();
                option.data.forEach((point, i) => {
                    const x = xScale(point.year);
                    const y = yScale(point.cost);
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                ctx.setLineDash([]); // Reset line dash
                
                // Draw markers every year
                option.data.forEach((point, i) => {
                    const x = xScale(point.year);
                    const y = yScale(point.cost);
                    
                    // Draw markers every year, but make them slightly smaller for density
                    if (point.year % 1 === 0) { // Every year
                        drawMarker(ctx, x, y, markerType, option.color, 3);
                    }
                });
            });
            
            // Add labels for X-axis (years) - now every 5 years
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            for (let year = 0; year <= maxYear; year += 5) {
                const x = xScale(year);
                // Make every 10 year label bold
                if (year % 10 === 0) {
                    ctx.font = 'bold 12px Arial';
                } else {
                    ctx.font = '11px Arial';
                }
                ctx.fillText(year.toString(), x, margin.top + chartHeight + 20);
            }
            
            // Add labels for Y-axis (costs)
            ctx.textAlign = 'right';
            for (let cost = 0; cost <= maxCost; cost += costStep) {
                const y = yScale(cost);
                const label = '$' + Math.round(cost / 1000) + 'k';
                ctx.fillText(label, margin.left - 10, y + 4);
            }
            
            // Add axis titles
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Years', margin.left + chartWidth/2, canvas.height - 20);
            
            ctx.save();
            ctx.translate(20, margin.top + chartHeight/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('Cumulative Total Cost', 0, 0);
            ctx.restore();
            
            // Add chart title
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('50-Year Total Cost Projection (Including Inflation)', margin.left + chartWidth/2, 25);
                        
            // Add legend
            const legendY = canvas.height - 50;
            let legendX = margin.left;

            projectionData.forEach((option, index) => {
                const markerType = markerTypes[index % markerTypes.length];
                
                // Draw line sample
                ctx.strokeStyle = option.color;
                ctx.lineWidth = option.isGeothermal ? 3 : 2;
                ctx.setLineDash(option.isGeothermal ? [] : [5, 5]);
                
                ctx.beginPath();
                ctx.moveTo(legendX, legendY);
                ctx.lineTo(legendX + 30, legendY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw marker sample in the middle of the line
                drawMarker(ctx, legendX + 15, legendY, markerType, option.color, 3);
                
                // Add text
                ctx.fillStyle = option.color;
                ctx.font = '11px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(option.name, legendX + 35, legendY + 4);
                
                // Move to next legend position
                const textWidth = ctx.measureText(option.name).width;
                legendX += 35 + textWidth + 20;
                
                // Wrap to next line if needed
                if (legendX > canvas.width - 200) {
                    legendX = margin.left;
                    legendY += 15;
                }
            });
        }
        
        // File handling functions
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('fileStatus');
            const errorEl = document.getElementById('fileError');
            
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                statusEl.style.display = 'none';
            } else {
                statusEl.textContent = message;
                statusEl.style.display = 'block';
                errorEl.style.display = 'none';
            }
            
            setTimeout(() => {
                statusEl.style.display = 'none';
                errorEl.style.display = 'none';
            }, 3000);
        }

        function downloadTemplate() {
            // Always provide blank template with sample data that users can replace
            const template = `Type,Name,Cost,SEER,HSPF
HeatPump,My Heat Pump Quote 1,0,15,8.2
HeatPump,My Heat Pump Quote 2,0,16,8.5
Geothermal,My Geothermal Quote 1,0,18,9
Geothermal,My Geothermal Quote 2,0,20,9.5`;
            
            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hvac_vendor_template.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Blank template downloaded! Fill in your actual vendor quotes and costs, then load the file.');
        }

        function loadExampleData() {
            // Real vendor quote data for demonstration
            const exampleData = `Type,Name,Cost,SEER,HSPF
HeatPump,Heat Pump Haller (Real Quote),15401,14.5,7.8
HeatPump,Heat Pump Grainer Brothers,9500,15,8.2
HeatPump,Heat Pump Haller (Theoretical Quote),20000,21,10
Geothermal,Geothermal Haller,60000,18,9
Geothermal,Geothermal Morrison,51952,18,9`;
            
            try {
                parseVendorData(exampleData);
                showStatus('Example data loaded! This shows real vendor quotes for comparison.');
            } catch (error) {
                showStatus('Error loading example data: ' + error.message, true);
            }
        }

        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    parseVendorData(text);
                } catch (error) {
                    showStatus('Error reading file: ' + error.message, true);
                }
            };
            reader.readAsText(file);
        }

        function parseVendorData(text) {
            try {
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                if (lines.length === 0) {
                    throw new Error('File is empty');
                }
                
                // Check if first line is header
                const hasHeader = lines[0].toLowerCase().includes('type') || lines[0].toLowerCase().includes('name');
                const dataLines = hasHeader ? lines.slice(1) : lines;
                
                if (dataLines.length === 0) {
                    throw new Error('No data rows found in file');
                }
                
                // Clear existing vendors completely
                const heatPumpContainer = document.getElementById('heatPumpVendors');
                const geothermalContainer = document.getElementById('geothermalVendors');
                heatPumpContainer.innerHTML = '';
                geothermalContainer.innerHTML = '';
                heatPumpCounter = 0;
                geothermalCounter = 0;
                
                let hpCount = 0, geoCount = 0;
                let validRows = 0;
                
                dataLines.forEach((line, index) => {
                    if (!line.trim()) return; // Skip empty lines
                    
                    const parts = line.split(',').map(part => part.trim().replace(/"/g, ''));
                    
                    if (parts.length < 5) {
                        console.warn(`Line ${index + 2}: Expected 5 columns (Type,Name,Cost,SEER,HSPF), got ${parts.length}: ${line}`);
                        return;
                    }
                    
                    const [type, name, cost, seer, hspf] = parts;
                    const costNum = parseFloat(cost);
                    const seerNum = parseFloat(seer);
                    const hspfNum = parseFloat(hspf);
                    
                    if (isNaN(costNum) || isNaN(seerNum) || isNaN(hspfNum)) {
                        console.warn(`Line ${index + 2}: Invalid numeric values - Cost: ${cost}, SEER: ${seer}, HSPF: ${hspf}`);
                        return;
                    }
                    
                    if (!name || name.trim() === '') {
                        console.warn(`Line ${index + 2}: Missing name`);
                        return;
                    }
                    
                    validRows++;
                    
                    if (type.toLowerCase().includes('heat') || type.toLowerCase() === 'hp' || type.toLowerCase().includes('pump')) {
                        hpCount++;
                        addVendorFromData('hp', hpCount, name, costNum, seerNum, hspfNum);
                    } else if (type.toLowerCase().includes('geo') || type.toLowerCase().includes('thermal')) {
                        geoCount++;
                        addVendorFromData('geo', geoCount, name, costNum, seerNum, hspfNum);
                    } else {
                        console.warn(`Line ${index + 2}: Unknown type "${type}" - use "HeatPump" or "Geothermal"`);
                    }
                });
                
                if (validRows === 0) {
                    throw new Error('No valid data rows found. Check file format.');
                }
                
                // Ensure minimum 1 vendor of each type for comparison
                if (hpCount === 0) {
                    showStatus('No heat pump options found in file. Please add at least one heat pump quote.', true);
                    return;
                }
                
                if (geoCount === 0) {
                    showStatus('No geothermal options found in file. Add geothermal quotes if you want to compare them.', false);
                }
                
                // Force recalculation
                setTimeout(() => {
                    calculateAll();
                }, 100);
                
                showStatus(`Successfully loaded ${hpCount} heat pump and ${geoCount} geothermal options from file.`);
                
            } catch (error) {
                showStatus('Error parsing file: ' + error.message, true);
                console.error('Parse error:', error);
            }
        }

        function addVendorFromData(type, id, name, cost, seer, hspf) {
            const container = document.getElementById(type === 'hp' ? 'heatPumpVendors' : 'geothermalVendors');
            const vendorHTML = createVendorHTML(type, id, name, cost, seer, hspf);
            container.insertAdjacentHTML('beforeend', vendorHTML);
            
            if (type === 'hp') {
                heatPumpCounter = Math.max(heatPumpCounter, id);
            } else {
                geothermalCounter = Math.max(geothermalCounter, id);
            }
        }

        function exportData() {
            const data = [];
            data.push(['Type', 'Name', 'Cost', 'SEER', 'HSPF']);
            
            // Export heat pump options
            for (let i = 1; i <= heatPumpCounter; i++) {
                const element = document.getElementById(`hpVendor${i}`);
                if (element) {
                    const name = getText(`hpName${i}`);
                    const cost = getVal(`hpCost${i}`);
                    const seer = getVal(`hpSEER${i}`);
                    const hspf = getVal(`hpHSPF${i}`);
                    if (name && cost > 0) {
                        data.push(['HeatPump', name, cost, seer, hspf]);
                    }
                }
            }
            
            // Export geothermal options
            for (let i = 1; i <= geothermalCounter; i++) {
                const element = document.getElementById(`geoVendor${i}`);
                if (element) {
                    const name = getText(`geoName${i}`);
                    const cost = getVal(`geoCost${i}`);
                    const seer = getVal(`geoSEER${i}`);
                    const hspf = getVal(`geoHSPF${i}`);
                    if (name && cost > 0) {
                        data.push(['Geothermal', name, cost, seer, hspf]);
                    }
                }
            }
            
            const csv = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hvac_analysis_data.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Analysis data exported successfully!');
        }
        
        // Initialize on page load
        window.onload = function() {
            console.log('Page loading...');
            // Add a small delay to ensure DOM is fully ready
            setTimeout(() => {
                console.log('Starting initialization...');
                initializeVendors();
                console.log('Running initial calculation...');
                calculateAll();
                console.log('Initialization complete');
            }, 200);
        };
    </script>
</body>
</html>